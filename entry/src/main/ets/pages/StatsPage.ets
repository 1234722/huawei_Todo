//entry\src\main\ets\pages\StatsPage.ets
import { VChart } from '@visactor/harmony-vchart'
import {
  AnimationNormalSpec,
  BarData,
  BarShape,
  BarSpec, BarValue, DayPoint, LineSpec, MonthPoint, PieData, PieSpec } from '../model/DateMapInterface';
import { getFormattedDate } from '../utils/DateTimeUtils';
import { FocusRecord } from '../utils/FocusRecord'
import { todoUIState } from '../viewModel/todoUIstate';



/* ---------- é¡µé¢ç»„ä»¶ ---------- */
@Entry
@Component
struct StatsPage {
  /* ---------- åŸå§‹è®°å½• ---------- */
  private records: FocusRecord[] = [
    { start: Date.now(), duration: 1, giveUp: false }   // â† æ¯«ç§’çº§æ—¶é—´æˆ³, å–å½“å‰è®¾å¤‡æ—¶é—´
  ]
  @State viewModel: todoUIState = todoUIState.getInstance(getContext(this))

  /* ---------- ç´¯è®¡ / ä»Šæ—¥æŒ‡æ ‡ ---------- */
  private totalCount   = this.viewModel.totalCount
  private totalMinutes = this.viewModel.totalTime
  private avgPerDay    = this.totalCount > 0 ? this.totalMinutes / this.totalCount : 0   // é˜² 0 æ”¹ä¸ºç´¯è®¡æ¯æ¬¡å¹³å‡æ—¶é—´ï¼Œä½†å˜é‡åæœªæ”¹

  /* â€”â€” ä»Šæ—¥ â€”â€” */
  private todayKey     = getFormattedDate()
  private todayStats   = this.viewModel.itemTable[this.todayKey]   // å¯èƒ½ä¸º undefined

  private todayCount   = this.todayStats?.totalCount ?? 0
  private todayMinutes = (this.todayStats?.totalTime ?? 0)
  private todayGiveUp  = this.todayMinutes > 0 ? this.todayMinutes / this.todayCount : 0    // ä¹Ÿæ”¹ä¸ºä»Šæ—¥æ¯æ¬¡å¹³å‡æ—¶é—´ï¼Œä½†å˜é‡åæœªæ”¹

  /* ---- å›¾è¡¨çŠ¶æ€ ---- */
  @State pieSpec      : PieSpec           = { type: 'pie', outerRadius: '0%', data: [] }
  @State barSpec      : BarSpec           = { type: 'bar', xField: '', yField: '', data: [], axes: [] }
  @State monthLineSpec: LineSpec<DayPoint>   = { type: 'line', xField: '', yField: '', smooth: true, data: [] }
  @State yearLineSpec : LineSpec<MonthPoint> = { type: 'line', xField: '', yField: '', smooth: true, data: [] }

  /* ---- æŠ˜çº¿åŸå§‹æ•°æ® ---- */
  private monthLineData: DayPoint[]   = []
  private yearLineData : MonthPoint[] = []

  /* ---- ç”Ÿå‘½å‘¨æœŸ ---- */
  onPageShow() {
    this.aggregate()
    this.buildSpecs()
  }

  /* ---------- æ•°æ®èšåˆ ---------- */
  private aggregate() {
    const now = new Date()
    const todayKey = `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()}`

    const dayMap   = new Map<string, number>()
    const monthMap = new Map<string, number>()

    this.records.forEach(r => {
      const d = new Date(r.start)
      const dayKey   = `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`
      const monthKey = `${d.getFullYear()}-${d.getMonth() + 1}`

      this.totalCount   += 1
      this.totalMinutes += r.duration

      if (dayKey === todayKey) {
        this.todayCount   += 1
        this.todayMinutes += r.duration
        if (r.giveUp) this.todayGiveUp += 1
      }

      dayMap.set(dayKey,   (dayMap.get(dayKey)   ?? 0) + r.duration)
      monthMap.set(monthKey, (monthMap.get(monthKey) ?? 0) + r.duration)
    })

    this.avgPerDay = this.totalMinutes === 0 ? 0
      : Math.round(this.totalMinutes / dayMap.size)

    /* æŠ˜çº¿æ•°æ®æ•°ç»„ */
    this.monthLineData = []
    dayMap.forEach((v, k) => this.monthLineData.push({ day: k, value: v }))

    this.yearLineData = []
    monthMap.forEach((v, k) => this.yearLineData.push({ month: k, value: v }))
  }

  /* ---------- ç»„è£…å›¾è¡¨ ---------- */
  private buildSpecs() {
    /* --- é¥¼å›¾ --- */
    const pieData: PieData[] = [
      {
        id: 'today',
        values: [
          { name: 'ä¸“æ³¨', value: this.todayMinutes > 0 ? this.todayMinutes : 1 }
        ]
      }
    ]
    this.pieSpec = {
      type: 'pie',
      outerRadius: '80%',
      data: pieData
    }

    /* --- æœ€è¿‘ 7 å¤©æŸ±å›¾ --- */
    const today   = new Date()
    const ONE_DAY = 24 * 60 * 60 * 1000
    const last7: BarValue[] = []

    for (let i = 6; i >= 0; i--) {
      const d       = new Date(today.getTime() - i * ONE_DAY)
      const key     = `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`   // ä¸ itemTable çš„é”®ä¸€è‡´
      const stat    = this.viewModel.itemTable[key]            // å¯èƒ½ undefined
      const minutes = (stat?.totalTime ?? 0)               // ä½ å­˜çš„æ˜¯ç§’å°± /60ï¼›è‹¥å·²æ˜¯åˆ†é’Ÿå¯å»æ‰ /60

      last7.push({
        day:   `${d.getMonth() + 1}/${d.getDate()}`,           // X è½´æ ‡ç­¾
        value: minutes                                          // Y è½´æ•°å€¼
      })
    }

    const barData: BarData[] = [
      { id: 'byDay', values: last7 }
    ]

    const barShape: BarShape = {
      style: { fill: '#7E6BEA', radius: 0 }
    }

    const barAnimation: AnimationNormalSpec = {
      bar: [
        {
          loop: true,
          startTime: 100,
          oneByOne: 100,
          timeSlices: [
            {
              delay: 1000,
              effects: {
                channel: {
                  fillOpacity: { to: 0.5 }
                },
                easing: 'linear'
              },
              duration: 500
            },
            {
              effects: {
                channel: {
                  fillOpacity: { to: 1 }
                },
                easing: 'linear'
              },
              duration: 500
            }
          ]
        }
      ]
    }


    this.barSpec = {
      type: 'bar',
      xField: 'day',
      yField: 'value',
      data: barData,
      padding: { top: 16, right: 16, bottom: 24, left: 16 },
      axes: [
        { orient: 'left' },
        { orient: 'bottom', type: 'band', paddingInner: 0.4, paddingOuter: 0.05 }
      ],
      barWidth: 28,
      bar: barShape,
      /* ğŸ”½ æŠŠåŠ¨ç”»å¯¹è±¡æŒ‚åˆ° animationNormal å³å¯ */
      animationNormal: barAnimation
    } as BarSpec



    /* --- æ—¥çº¿ï¼šæœ¬æœˆæ¯å¤©çš„ä¸“æ³¨æ—¶é•¿ï¼ˆåˆ†é’Ÿï¼‰ --- */
    const now     = new Date()
    const year    = now.getFullYear()
    const month   = now.getMonth() + 1                           // 1â€‘12
    const daysInMonth = new Date(year, month, 0).getDate()       // è¯¥æœˆå¤©æ•°

    // ç”Ÿæˆ daysInMonth çš„é¡ºåºæ•°ç»„
    const monthPoints: DayPoint[] = []
    for (let d = 1; d <= daysInMonth; d++) {
      const key   = `${year}-${month}-${d}`                      // ä¸ itemTable çš„é”®ä¿æŒä¸€è‡´
      const stat  = this.viewModel.itemTable[key]                // å¯èƒ½ä¸º undefined
      const minutes = (stat?.totalTime ?? 0)               // è‹¥å·²å­˜åˆ†é’Ÿå¯å»æ‰ /60

      monthPoints.push({
        day:   `${month}/${d}`,                                   // X è½´æ ‡ç­¾ï¼šMM/DD
        value: minutes                                            // Y è½´ï¼šå½“å¤©åˆ†é’Ÿæ•°
      })
    }

    this.monthLineData = monthPoints

    this.monthLineSpec = {
      type: 'line',
      xField: 'day',
      yField: 'value',
      smooth: true,
      data: [
        { id: 'daily', values: this.monthLineData }
      ]
    } as LineSpec<DayPoint>


    /* --- æœˆçº¿ --- */
    this.yearLineSpec = {
      type: 'line',
      xField: 'month',
      yField: 'value',
      smooth: true,
      data: [ { id: 'monthly', values: this.yearLineData } ]
    }
  }

  /* ---------- UI ---------- */
  build() {
    Scroll() {
      Column() {
        Row(){
          Text("æ•°æ®ç»Ÿè®¡")
            .fontFamily('HarmonyHeiTi-Bold')
            .fontColor('#FFFFFF')
            .fontWeight("700")
            .fontSize("24")
        }
        .width('100%')
        .margin({ left: 16, top: 36 })

        /* ç´¯è®¡æŒ‡æ ‡ */
        Column(){
          Text("ç´¯è®¡ä¸“æ³¨")
            .fontFamily('HarmonyHeiTi-Bold')
            .width('100%')
            .fontSize("12")
            .margin({ left: 16, top: 8 })
            .fontColor('#866EFA')
            .fontWeight("700")
          Row() {
            Blank()
              .layoutWeight(0.7)
            Card({ title: 'æ¬¡æ•°', value: `${this.totalCount}`,   sub: '' }).layoutWeight(1)
            //.margin({ left: 64, top: 4 })
            Card({ title: 'æ—¶é•¿', value: `${this.totalMinutes}`, sub: 'åˆ†é’Ÿ' }).layoutWeight(1)
            Card({ title: 'å¹³å‡', value: `${this.avgPerDay}`,    sub: 'åˆ†é’Ÿ' }).layoutWeight(1)
          }
        }
        .width('100%')
        .margin({ top: 12 })
        .backgroundColor(Color.White)
        .borderRadius(16)


        /* ä»Šæ—¥æŒ‡æ ‡ */
        Column() {
          Text("ä»Šæ—¥ä¸“æ³¨")
            .fontFamily('HarmonyHeiTi-Bold')
            .width('100%')
            .fontSize("12")
            .margin({ left: 16, top: 8 })
            .fontColor('#866EFA')
            .fontWeight("700")
          Row() {
            Blank()
              .layoutWeight(0.7)
            Card({ title: 'æ¬¡æ•°', value: `${this.todayCount}`, sub: '' }).layoutWeight(1)
            Card({ title: 'æ—¶é•¿', value: `${this.todayMinutes}`, sub: 'åˆ†é’Ÿ' }).layoutWeight(1)
            Card({ title: 'å¹³å‡', value: `${this.todayGiveUp}`, sub: 'æ¬¡æ•°' }).layoutWeight(1)
          }
        }
        .width('100%')
        .margin({ top: 12 })
        .backgroundColor(Color.White)
        .borderRadius(16)

        /* å›¾è¡¨ */
        //VChart({ spec: this.pieSpec       }).width('100%').height(260).margin({ top: 16 })
        //  .borderRadius(16)
        /* å›¾è¡¨å®¹å™¨ï¼šå…ˆåŒ…ä¸€å±‚ Stack å†è£å‰ªï¼Œå¯ç¡®ä¿åœ†è§’ç”Ÿæ•ˆ */
        /* --- å›¾è¡¨å®¹å™¨ --- */
        Stack() {
          /* 1ï¸âƒ£ å…ˆæ”¾åˆ°ä¸€ä¸ª Row é‡Œ */
          Column(){
            Text("å‘¨åº¦æ•°æ®")
              .fontFamily('HarmonyHeiTi-Bold')
              .width('100%')
              .fontSize("12")
              .margin({ left: 16, top: 8 })
              .fontColor('#866EFA')
              .fontWeight("700")
            Row() {
              VChart({ spec: this.barSpec })
                .width('90%')      // åªå å®¹å™¨ 90
                .height(290)
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)   // 2ï¸âƒ£ æ¨ªå‘å±…ä¸­
          }

        }
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .clip(true)
        .margin({ top: 16 })

        Stack() {
          Column() {
            Text("æœˆåº¦æ•°æ®")
              .fontFamily('HarmonyHeiTi-Bold')
              .width('100%')
              .fontSize("12")
              .margin({ left: 16, top: 8 })
              .fontColor('#866EFA')
              .fontWeight("700")
            VChart({ spec: this.monthLineSpec })
              .width('100%')
              .height(290)
          }
        }
        .backgroundColor('#FFFFFF')
        .borderRadius(16)
        .clip(true)
        .margin({ top: 16 })

      }
      .padding({ left: 12, right: 12, top: 12 , bottom:12})
      .backgroundColor("#7E6BEB")
    }
  }
}

/* ---------- å°å¡ç‰‡ç»„ä»¶ ---------- */
@Component
struct Card {
  @Prop title: string
  @Prop value: string
  @Prop sub  : string

  build() {
    Column() {
      Text(this.title).fontSize(12).fontColor('#866EFA')
      Text(this.value).fontSize(28).fontWeight(FontWeight.Bold).margin({ top: 4 }).fontColor('#866EFA')
      Text(this.sub  ).fontSize(10).fontColor('#866EFA').margin({ top: 4 })
    }                 // â† å…ˆç»“æŸ Column çš„å­æ ‘
    .padding(12)      // â† å†ä¾æ¬¡è¿½åŠ ä¿®é¥°å™¨
    .borderRadius(12)
    .backgroundColor('#ffffff')
    //.shadow({ radius: 4, color: '#22000000', offsetX: 0, offsetY: 2 })
    .height(84)
  }
}